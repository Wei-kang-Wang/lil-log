---
layout: post
comments: True
title: "3D视觉基础"
date: 2024-08-11 01:09:00

---

<!--more-->

{: class="table-of-content"}
* TOC
{:toc}

---

## 四个坐标系：世界坐标系（world coordinate system）、相机坐标系（camera coordinate system）、图像坐标系（image coordinate system）和像素坐标系（pixel coordinate system）

坐标系（coordinate system）又叫做coordinate frame，是理解3D vision的重要基础。有四个坐标系：世界坐标系（world coordinate system）、相机坐标系（camera coordinate system）、图像坐标系（image/film coordinate system）和像素坐标系（pixel coordinate system）是最常见的四个坐标系，其中世界坐标系和相机坐标系是三维坐标系，图像坐标系和像素坐标系是二维坐标系。

为了唯一地描述每一个空间点的坐标，以及相机的位置和朝向，我们需要先定义一个世界坐标系。接着，为了建立3D空间点到相机平面的映射关系以及多个相机之间的相对关系，我们会对每一个相机定义一个局部的相机坐标系。下图为常见的相机坐标系定义习惯：

![3dv0]({{ '/assets/images/3dv-0.png' | relative_url }}){: width=800px style="float:center"}
*常见的相机坐标系定义习惯（右手坐标系）。注意：在OpenCV/COLMAP的相机坐标系里相机朝向+z轴，在LLFF/NeRF的相机坐标系中里相机朝向-z轴。有时我们会按坐标系的xyz朝向描述坐标系，如OpenCV/COLMAP里使用的RDF表述X轴指向right，Y轴指向Down，Z轴指向Foward。*

> 以下用$$\text{UVW}$$表示世界坐标系，用$$\text{XYZ}$$表示相机坐标系，用$$\text{xy}$$表示图像坐标系，用$$\text{uv}$$表示二维坐标系。

世界坐标系是三维空间内的任意一个坐标系，相机坐标系一般是以相机光心为原点，相机光轴为$$Z$$轴，$$X-Y$$平面平行于相机成像平面的一个坐标系（且满足$$X$$轴和$$Y$$轴分别与成像平面两条边界分别平行。图像坐标系是定义在相机成像平面上的二维坐标系，以光轴和成像平面的交点为中心，$$x$$轴和$$y$$轴也分别平行于成像平面两条边界。像素坐标系也是定义在相机成像平面上的二维坐标系，但和图像坐标系有两个区别：1）像素坐标系以成像平面左上角为原点，且可能$$u$$轴和$$v$$轴方向与图像坐标系的$$x$$轴和$$y$$轴方向相反；2）像素坐标系的单位距离是一个像素，其坐标是离散的，且由该点距离$$u$$轴和$$v$$轴各有多少个像素距离来决定。下图是四个坐标系的示意：

![3dv1]({{ '/assets/images/3dv-1.png' | relative_url }}){: width=800px style="float:center"}

从以世界坐标系表示的三维空间中的一点$$(U,V,W)$$到像素平面上一点$$(u,v)$$的过程如下：

![3dv2]({{ '/assets/images/3dv-2.png' | relative_url }}){: width=800px style="float:center"}

> 注意，将上述过程反过来，则是多数三维重建问题所要考虑的设定，是CV里一个最重要的分支之一。

**1. $$\text{UVW}$$到$$\text{XYZ}$$**

![3dv3]({{ '/assets/images/3dv-3.png' | relative_url }}){: width=800px style="float:center"}

假设相机坐标系原点在世界坐标系下的坐标为$$C$$，且相机坐标系$$\text{XYZ}$$是由世界坐标系$$\text{UVW}$$旋转$$R$$得来，那么空间中任意一个三维点$$P$$在世界坐标系下的坐标$$P_W=\left[ U,V,W \right]^T$$和在相机坐标系下的坐标$$P_C = \left[ X,Y,Z \right]^T$$之间的关系为：

$$P_C = R(P_W - C)$$

> 一定要注意上述公式里的符号，以及$$C$$是哪个坐标系的原点在哪个坐标系下的坐标

$${\left[ \begin{array}{cccc} X \\ Y \\ Z \\ 1 \end{array} \right]} = {\left[ \begin{array}{cccc} R_{11} & R_{12} & R_{13} & T_1 \\ R_{21} & R_{22} & R_{23} & T_2 \\ R_{31} & R_{32} & R_{33} & T_3 \\ 0 & 0 & 0 & 1 \end{array} \right]} {\left[ \begin{array}{cccc} U \\ V \\ W \\ 1 \end{array} \right]}$$

其中$${\left[ \begin{array}{ccc} R_{11} & R_{12} & R_{13} \\ R_{21} & R_{22} & R_{23} \\ R_{31} & R_{32} & R_{33} \end{array} \right]}$$是旋转矩阵$$R$$，$$\left[T_1, T_2, T_3 \right]$$是translation向量$$T$$。

注意$$T = -RC$$。

**2. $$\text{XYZ}$$到$$\text{xy}$$**

![3dv4]({{ '/assets/images/3dv-4.png' | relative_url }}){: width=800px style="float:center"}

上图表示的是将三维点在相机坐标系下的坐标变换为二维点在图像坐标系下的坐标的perspective projection模型（也是pinhole camera的模型），别的模型还有orthographic projection。空间中任意一个三维点$$P$$在相机坐标系下的坐标$$P_C= \left[ X,Y,Z \right]^T$$和该点经过perspective projection之后在图像坐标系下的坐标$$p=\left[ x,y \right]$$:

$${\left[ \begin{array}{ccc} x \\ y \\ 1 \end{array} \right]} = {\left[ \begin{array}{ccc} f & 0 & 0 & 0 \\ 0 & f & 0 & 0 \\ 0 & 0 & 1 & 0 \end{array} \right]} {\left[ \begin{array}{cccc} X \\ Y \\ Z \\ 1 \end{array} \right]}$$

**3. $$\text{xy}$$到$$\text{uv}$$**

下图左侧是图像坐标系$$x$$轴和$$y$$轴与像素坐标系$$u$$轴和$$v$$轴正方向相同的情况，右侧是相反的情况（一般情况下都是右侧）：

![3dv5]({{ '/assets/images/3dv-5.png' | relative_url }}){: width=400px style="float:center"} | ![3dv6]({{ '/assets/images/3dv-6.png' | relative_url }}){: width=400px style="float:center"}

空间中任意一点在图像坐标系下的坐标$$p=\left[ x,y \right]$$和其在像素坐标系下的坐标$$p^{\prime} = \left[u, v \right]$$的关系如下（以上图右侧为例）：

$${\left[ \begin{array}{ccc} u \\ v \\ 1 \end{array} \right]} = {\left[ \begin{array}{ccc} -\frac{1}{s_x} & 0 & o_x \\ 0 & -\frac{1}{s_y} & o_y \end{array} \right]} {\left[ x \\ y \\ 1 \right]}$$

上面就是世界坐标系、相机坐标系、图像坐标系和像素坐标系之间的关系。

## 相机外参（extrinsics）和相机内参（intrinsics）

世界坐标系和相机坐标系之间的转换矩阵$$\left[R \vert T \right]$$即是相机外参（extrinsics），而联系相机坐标系和像素坐标系之间的转换矩阵，定义为相机内参。按照上述对四个坐标系的介绍，相机内参矩阵一般如下：

$${\left[ \begin{array}{ccc} -f/s_x & \alpha_x & o_x & 0 \\ \alpha_y & -f/s_y & o_y & 0 \\ 0 & 0 & 1 & 0 \right]} = {\left[ \begin{array}{ccc} -f_x & \alpha_x & o_x & 0 \\ \alpha_y & -f_y & o_y & 0 \\ 0 & 0 & 1 & 0 \right]}

> 注意上述矩阵里的$$\alpha_x$$和$$\alpha_y$$，其是用来解释畸变的，在一般情况下都假设为0。而$$f_x$$和$$f_y$$在一般情况下也假设相同。

## 单映（homography）

## 极几何（Epipolar geometry）

essential & fundamental matrix，8-point algorithm

## 立体视觉（stereo vision）和深度估计

## Structure-from-Motion


## 参考文献
1. pinhole camera的博客：https://hedivision.github.io/Pinhole.html
2. perspective and orthographic projection matrix的博客：https://scratchapixel.com/lessons/3d-basic-rendering/perspective-and-orthographic-projection-matrix/projection-matrix-introduction.html
3. https://homepages.inf.ed.ac.uk/rbf/CVonline/LOCAL_COPIES/EPSRC_SSAZ/node3.html
4. https://github.com/facebookresearch/pytorch3d/blob/main/docs/notes/cameras.md
5. https://zhuanlan.zhihu.com/p/593204605/
6. https://math.stackexchange.com/questions/2278225/rodrigues-formula
7. https://zhuanlan.zhihu.com/p/389653208
8. https://extrelin.github.io/2018/05/10/plucker-coordinates/
9. https://homepages.inf.ed.ac.uk/rbf/CVonline/LOCAL_COPIES/EPSRC_SSAZ/node3.html
10. https://extrelin.github.io/2018/05/10/plucker-coordinates/
11. https://github.com/facebookresearch/pytorch3d/tree/main/docs/notes
12. https://math.stackexchange.com/questions/879351/matrix-exponential-of-a-skew-symmetric-matrix-without-series-expansion
13. https://zhuanlan.zhihu.com/p/593204605/
14. https://math.stackexchange.com/questions/2278225/rodrigues-formula
15. https://zhuanlan.zhihu.com/p/389653208
16. https://pytorch3d.org/docs/cameras
17. https://www.cnblogs.com/gs590/p/16834833.html
18. https://zhuanlan.zhihu.com/p/45404840
19. https://zhuanlan.zhihu.com/p/451579313
20. https://zhuanlan.zhihu.com/p/552607272
21. https://blog.csdn.net/wxc_1998/article/details/119009765
22. https://blog.csdn.net/woyaomaishu2/article/details/131388130?spm=1001.2101.3001.6650.2&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-2-131388130-blog-119009765.235%5Ev38%5Epc_relevant_default_base3&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-2-131388130-blog-119009765.235%5Ev38%5Epc_relevant_default_base3&utm_relevant_index=5
23. https://blog.csdn.net/minmindianzi/article/details/84279290
24. https://blog.csdn.net/Anchor_Yin/article/details/120238915
25. https://zhuanlan.zhihu.com/p/56007747
26. https://zhuanlan.zhihu.com/p/183973440
27. https://zhuanlan.zhihu.com/p/144032401
28. https://www.zhihu.com/tardis/zm/art/437461225?source_id=1003
